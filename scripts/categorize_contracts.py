import csv
import os

# Directory paths
# TODO: Refactor directory paths and path traversal to use os.path.join
WDIR = "/home/nikolas/Documents/smartcontracts/contractdb"
formal_csv = [f for f in os.listdir(WDIR + "/formal_csv") if not f.startswith('.')]
 
overlap_with_lines = [f for f in os.listdir(WDIR + "/overlap-with-lines") if not f.startswith('.')]
# File paths
file1 = WDIR + "/overlap-with-lines/FE_lines.csv"
file2 = WDIR + "/formal_csv/FE.csv"


# Create output folders 
if not os.path.exists(WDIR + "/categorized"):
    os.mkdir(WDIR + "/categorized")
if not os.path.exists(WDIR + "/categorized/exploitable"):
    os.mkdir(WDIR + "/categorized/exploitable")
if not os.path.exists(WDIR + "/categorized/unexploitable"):
    os.mkdir(WDIR + "/categorized/unexploitable")
if not os.path.exists(WDIR + "/categorized/unknown_label"):
    os.mkdir(WDIR + "/categorized/unknown_label")
if not os.path.exists(WDIR + "/categorized/uncategorized"):
    os.mkdir(WDIR + "/categorized/uncategorized")

def contract_address_exists(writer, contract_address):
    for row in writer:
        if row["contract_address"] == contract_address:
            return True
    return False
remove_list = []
for file in formal_csv:
    filename2 = file.split(".")[0]
    # Check if the filename in formal_csv contains in overlap_with_lines
    filenames = [s for s in overlap_with_lines if filename2 in s]
    print(filenames)
    for filename in filenames:
        filename = filename.split(".")[0]
        filenamestrip = filename.split("_")[0]
        print("filenamestrip: " + filenamestrip + " filename2: " + filename2)
        if (filenamestrip == filename2):
            file1 = WDIR + "/overlap-with-lines/" + filename + ".csv"
            file2 = WDIR + "/formal_csv/" + filename2 + ".csv"
            # Open the input file
            # Create a dictionary from file2
            label_dict = {}
            with open(file2, "r") as file2:
                reader = csv.DictReader(file2)
                for row in reader:
                    contract_address = row["contract_address"]
                    final_label = row["final_label"]
                    label_dict[contract_address] = final_label
                file2.close()

            with open(file1, "r") as filed:
                # Read the file as a CSV
                reader1 = csv.DictReader(filed)
                # Iterate over the rows
                for row in reader1:
                    # Get the contract address from the row
                    contract_address = row["contract_address"]
                    if contract_address in label_dict:
                        final_label = label_dict[contract_address]
                        if final_label == "Exploitable":
                            file_exists = os.path.isfile(WDIR + "/categorized/exploitable/" + filename2 + ".csv")
                            with open(WDIR + "/categorized/exploitable/" + filename2 + ".csv", "a+") as exploit_file:
                                exploit_file.seek(0)
                                writer = csv.DictWriter(exploit_file, fieldnames=reader1.fieldnames, extrasaction='ignore',)
                                reader = csv.DictReader(exploit_file, fieldnames=reader1.fieldnames)
                                if not file_exists:
                                    writer.writeheader()
                                if not contract_address_exists(reader, contract_address):
                                    writer.writerow(row)
                                #exploit_file.close()
                        elif final_label == "Unexploitable":
                            file_exists = os.path.isfile(WDIR + "/categorized/unexploitable/" + filename2 + ".csv")
                            with open(WDIR + "/categorized/unexploitable/" + filename2 + ".csv", "a+") as unexploit_file:
                                unexploit_file.seek(0)
                                writer = csv.DictWriter(unexploit_file, fieldnames=reader1.fieldnames, extrasaction='ignore')
                                reader = csv.DictReader(unexploit_file, fieldnames=reader1.fieldnames)
                                if not file_exists:
                                    writer.writeheader()
                                if not contract_address_exists(reader, contract_address):
                                    writer.writerow(row)
                                #unexploit_file.close()
                        else:
                            row["final_label"] = final_label
                            file_exists = os.path.isfile(WDIR + "/categorized/unknown_label/" + filename2 + ".csv")
                            with open(WDIR + "/categorized/unknown_label/" + filename2 + ".csv", "a+") as unknown_file:
                                unknown_file.seek(0)
                                writer = csv.DictWriter(unknown_file, fieldnames=reader1.fieldnames, extrasaction='ignore',)
                                reader = csv.DictReader(unknown_file, fieldnames=reader1.fieldnames)
                                if not file_exists:
                                    writer.writeheader()
                                if not contract_address_exists(reader, contract_address):
                                    writer.writerow(row)
                                #unknown_file.close()    
                    else:
                        file_exists = os.path.isfile(WDIR + "/categorized/uncategorized/" + filename2 + ".csv")
                        with open(WDIR + "/categorized/uncategorized/" + filename2 + ".csv", "a+") as uncategorized_file:
                            uncategorized_file.seek(0)
                            writer = csv.DictWriter(uncategorized_file, fieldnames=reader1.fieldnames, extrasaction='ignore',)
                            reader = csv.DictReader(uncategorized_file, fieldnames=reader1.fieldnames)
                            if not file_exists:
                                    writer.writeheader()
                            if not contract_address_exists(reader, contract_address):
                                writer.writerow(row)
                            #uncategorized_file.close()
                filed.close()
            remove_list.append(file)

for file in remove_list:
    formal_csv.remove(file)
# TODO: The code below needs to change, because the rest of the files in formal_csv either are exploitable or unexploitable
for file in formal_csv:
    print(formal_csv)
    filename2 = file.split(".")[0]
    with open(WDIR + "/formal_csv/" + filename2 + ".csv", "r") as file:
        reader2 = csv.DictReader(file)
        for row in reader2:
            file_exists = os.path.isfile(WDIR + "/categorized/uncategorized/" + filename2 + ".csv")
            with open(WDIR + "/categorized/uncategorized/" + filename2 + ".csv", "a+") as uncategorized_file:
                uncategorized_file.seek(0)
                writer = csv.DictWriter(uncategorized_file, fieldnames=reader2.fieldnames, extrasaction='ignore',)
                reader = csv.DictReader(uncategorized_file, fieldnames=reader2.fieldnames)
                if not file_exists:
                    writer.writeheader()
                writer.writerow(row)
                uncategorized_file.close()


                        




